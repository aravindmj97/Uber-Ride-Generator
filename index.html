<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RideLink – Uber Deep Link Generator</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS (Maps) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Map Container Heights */
        .map-container { height: 250px; width: 100%; z-index: 1; border-radius: 0.5rem; }
        
        /* Smooth transitions */
        .transition-height { transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out; }
        
        /* The Shareable Card Styling */
        #share-card {
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
            color: white;
            position: relative;
            overflow: hidden;
            padding-bottom: 50px;
        }
        
        /* Decoration circles on card */
        .deco-circle {
            position: absolute;
            border-radius: 50%;
            opacity: 0.1;
            background: white;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Header -->
    <header class="bg-black text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="max-w-md mx-auto flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-white text-black rounded-full flex items-center justify-center font-bold text-xl">U</div>
                <h1 class="font-bold text-lg tracking-tight">RideLink – Uber Deep Link Generator</h1>
            </div>
            <i class="fa-solid fa-route text-gray-400"></i>
        </div>
    </header>

    <main class="max-w-md mx-auto p-4 pb-24">

        <!-- STEP 1: PICKUP -->
        <section class="bg-white rounded-xl shadow-sm border border-gray-100 p-5 mb-4">
            <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                <i class="fa-solid fa-location-dot text-green-600"></i> 1. Pickup Location
            </h2>

            <!-- Pickup Type Toggle -->
            <div class="flex gap-2 mb-4">
                <button onclick="setPickupMode('current')" id="btn-pickup-current" class="flex-1 py-3 px-2 rounded-lg border-2 border-black bg-black text-white font-medium text-sm transition-all text-center">
                    Current Location
                </button>
                <button onclick="setPickupMode('custom')" id="btn-pickup-custom" class="flex-1 py-3 px-2 rounded-lg border-2 border-gray-200 text-gray-600 font-medium text-sm hover:border-gray-400 transition-all text-center">
                    Select on Map
                </button>
            </div>

            <!-- Custom Pickup Area (Hidden by default) -->
            <div id="pickup-custom-area" class="hidden space-y-3">
                <div class="flex gap-2">
                    <input type="text" id="pickup-search" placeholder="Search (e.g., Central Park)" class="flex-1 p-3 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-black outline-none">
                    <button onclick="searchLocation('pickup')" class="bg-gray-200 text-black px-4 rounded-lg hover:bg-gray-300">
                        <i class="fa-solid fa-magnifying-glass"></i>
                    </button>
                </div>
                <div id="pickup-map" class="map-container border border-gray-300"></div>
                <p id="pickup-status" class="text-xs text-gray-500 italic">Search or tap map to select.</p>
            </div>
        </section>

        <!-- STEP 2: DROP OFF -->
        <section class="bg-white rounded-xl shadow-sm border border-gray-100 p-5 mb-4">
            <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                <i class="fa-solid fa-flag-checkered text-red-600"></i> 2. Destination
            </h2>

            <div class="space-y-3">
                <div class="flex gap-2">
                    <input type="text" id="dropoff-search" placeholder="Search destination..." class="flex-1 p-3 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-black outline-none">
                    <button onclick="searchLocation('dropoff')" class="bg-gray-200 text-black px-4 rounded-lg hover:bg-gray-300">
                        <i class="fa-solid fa-magnifying-glass"></i>
                    </button>
                </div>
                <div id="dropoff-map" class="map-container border border-gray-300"></div>
                <p id="dropoff-status" class="text-xs text-gray-500 italic">Search or tap map to select.</p>
            </div>
        </section>

        <!-- GENERATE BUTTON -->
        <button onclick="generateLink()" class="w-full bg-black text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:bg-gray-900 transition-transform active:scale-95 flex items-center justify-center gap-2">
            Create Ride Link <i class="fa-solid fa-wand-magic-sparkles"></i>
        </button>

        <!-- RESULTS SECTION (Hidden Initially) -->
        <div id="result-section" class="hidden mt-6 animate-fade-in">
            
            <!-- Quick Actions -->
            <div class="grid grid-cols-2 gap-3 mb-6">
                <a id="btn-open-uber" href="#" class="col-span-2 bg-black text-white py-3 rounded-lg font-semibold text-center hover:bg-gray-800 flex items-center justify-center gap-2">
                    Open Uber App <i class="fa-solid fa-arrow-up-right-from-square"></i>
                </a>
                <button onclick="copyLink()" class="bg-gray-100 text-gray-800 py-3 rounded-lg font-medium hover:bg-gray-200 flex items-center justify-center gap-2">
                    <i class="fa-regular fa-copy"></i> Copy
                </button>
                <button onclick="shareLink()" class="bg-gray-100 text-gray-800 py-3 rounded-lg font-medium hover:bg-gray-200 flex items-center justify-center gap-2">
                    <i class="fa-solid fa-share-nodes"></i> Share
                </button>
            </div>

            <!-- Shareable Card Visual -->
            <h3 class="font-bold text-gray-500 text-sm uppercase tracking-wider mb-2">Shareable Card</h3>
            
            <div id="share-card" class="rounded-2xl p-6 shadow-2xl mx-auto w-full max-w-sm aspect-[4/5] flex flex-col justify-between">
                <!-- Deco -->
                <div class="deco-circle w-32 h-32 -top-10 -right-10"></div>
                <div class="deco-circle w-24 h-24 bottom-20 -left-10"></div>

                <!-- Header -->
                <div class="relative z-10 flex justify-between items-start">
                    <div>
                        <h2 class="text-2xl font-extrabold tracking-tighter text-white">Ride Request</h2>
                        <p class="text-gray-400 text-sm">Scan to book this ride</p>
                    </div>
                    <div class="bg-white text-black font-bold px-2 py-1 rounded text-xs">UBER</div>
                </div>

                <!-- Route Info -->
                <div class="relative z-10 my-4 space-y-4">
                    <div class="flex items-start gap-3">
                        <div class="mt-1 w-2 h-2 rounded-full bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.6)]"></div>
                        <div>
                            <p class="text-[10px] text-gray-400 uppercase font-bold">From</p>
                            <p id="card-pickup-text" class="text-white font-medium leading-tight">My Location</p>
                        </div>
                    </div>
                    <!-- Dotted Line -->
                    <div class="h-4 border-l border-dashed border-gray-600 ml-[3px]"></div>
                    <div class="flex items-start gap-3">
                        <div class="mt-1 w-2 h-2 rounded-full bg-red-500 shadow-[0_0_10px_rgba(239,68,68,0.6)]"></div>
                        <div>
                            <p class="text-[10px] text-gray-400 uppercase font-bold">To</p>
                            <p id="card-dropoff-text" class="text-white font-medium leading-tight">Select Destination</p>
                        </div>
                    </div>
                </div>

                <!-- QR Code Box -->
                <div class="relative z-10 bg-white p-4 rounded-3xl self-center w-64 h-64 shrink-0 flex items-center justify-center shadow-lg overflow-hidden">
                    <div id="qrcode" class="flex justify-center items-center"></div>
                </div>
                
                <div class="relative z-10 text-center mt-2">
                    <p class="text-[10px] text-gray-500">Generated via Uber Link Tool</p>
                </div>
            </div>

            <!-- Download Button -->
            <button onclick="downloadCard()" class="w-full mt-4 border-2 border-black text-black py-3 rounded-xl font-bold hover:bg-gray-100 flex items-center justify-center gap-2">
                Download Card Image <i class="fa-solid fa-download"></i>
            </button>

        </div>

    </main>

    <!-- Modal for Messages -->
    <div id="toast" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-lg opacity-0 pointer-events-none transition-opacity z-50 text-sm font-medium">
        Notification
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        // --- State Management ---
        const state = {
            pickupMode: 'current', // 'current' or 'custom'
            pickup: { lat: null, lng: null, address: 'My Location' },
            dropoff: { lat: null, lng: null, address: '' },
            generatedUrl: ''
        };

        let mapPickup, mapDropoff;
        let markerPickup, markerDropoff;

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initMaps();
        });

        // --- Map Functions ---
        function initMaps() {
            // Default center (Bengaluru, India)
            const defaultView = [12.9716, 77.5946]; 

            // Initialize Pickup Map
            mapPickup = L.map('pickup-map').setView(defaultView, 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap'
            }).addTo(mapPickup);
            
            mapPickup.on('click', (e) => {
                handleMapClick(e.latlng, 'pickup');
            });

            // Initialize Dropoff Map
            mapDropoff = L.map('dropoff-map').setView(defaultView, 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap'
            }).addTo(mapDropoff);

            mapDropoff.on('click', (e) => {
                handleMapClick(e.latlng, 'dropoff');
            });

            // Try to get user's current location to center maps initially
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    const { latitude, longitude } = pos.coords;
                    mapPickup.setView([latitude, longitude], 15);
                    mapDropoff.setView([latitude, longitude], 15);
                });
            }
        }

        async function handleMapClick(latlng, type) {
            const { lat, lng } = latlng;
            
            // Reverse geocode to get address for display
            try {
                showToast("Fetching address...");
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                const data = await response.json();
                
                let address = "Selected Location";
                if(data && data.address) {
                    // Try to construct a short meaningful address
                    address = data.address.road || data.address.building || data.display_name.split(',')[0];
                }

                updateLocationState(type, lat, lng, address);

            } catch (error) {
                console.error("Geocoding failed", error);
                updateLocationState(type, lat, lng, `${lat.toFixed(4)}, ${lng.toFixed(4)}`);
            }
        }

        function updateLocationState(type, lat, lng, address) {
            if (type === 'pickup') {
                state.pickup = { lat, lng, address };
                if (markerPickup) mapPickup.removeLayer(markerPickup);
                markerPickup = L.marker([lat, lng]).addTo(mapPickup);
                document.getElementById('pickup-status').innerText = `Selected: ${address}`;
                document.getElementById('pickup-search').value = address;
            } else {
                state.dropoff = { lat, lng, address };
                if (markerDropoff) mapDropoff.removeLayer(markerDropoff);
                markerDropoff = L.marker([lat, lng]).addTo(mapDropoff);
                document.getElementById('dropoff-status').innerText = `Selected: ${address}`;
                document.getElementById('dropoff-search').value = address;
            }
        }

        // --- Search Functionality ---
        async function searchLocation(type) {
            const inputId = type === 'pickup' ? 'pickup-search' : 'dropoff-search';
            const query = document.getElementById(inputId).value;

            if (!query) {
                showToast("Please enter a location to search");
                return;
            }

            try {
                showToast("Searching...");
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
                const results = await response.json();

                if (results && results.length > 0) {
                    const first = results[0];
                    const lat = parseFloat(first.lat);
                    const lon = parseFloat(first.lon);
                    
                    const map = type === 'pickup' ? mapPickup : mapDropoff;
                    map.setView([lat, lon], 16);
                    updateLocationState(type, lat, lon, first.display_name.split(',')[0]);
                } else {
                    showToast("Location not found");
                }
            } catch (error) {
                showToast("Search failed. Try selecting on map.");
            }
        }

        // --- UI Logic ---
        function setPickupMode(mode) {
            state.pickupMode = mode;
            const btnCurrent = document.getElementById('btn-pickup-current');
            const btnCustom = document.getElementById('btn-pickup-custom');
            const customArea = document.getElementById('pickup-custom-area');

            if (mode === 'current') {
                btnCurrent.classList.replace('bg-white', 'bg-black');
                btnCurrent.classList.replace('text-gray-600', 'text-white');
                btnCurrent.classList.replace('border-gray-200', 'border-black');

                btnCustom.classList.replace('bg-black', 'bg-white');
                btnCustom.classList.replace('text-white', 'text-gray-600');
                btnCustom.classList.replace('border-black', 'border-gray-200');

                customArea.classList.add('hidden');
                state.pickup.address = "My Location";
            } else {
                btnCustom.classList.replace('bg-white', 'bg-black');
                btnCustom.classList.replace('text-gray-600', 'text-white');
                btnCustom.classList.replace('border-gray-200', 'border-black');

                btnCurrent.classList.replace('bg-black', 'bg-white');
                btnCurrent.classList.replace('text-white', 'text-gray-600');
                btnCurrent.classList.replace('border-black', 'border-gray-200');

                customArea.classList.remove('hidden');
                // Invalidating size helps Leaflet render correctly when unhidden
                setTimeout(() => mapPickup.invalidateSize(), 200);
            }
        }

        // --- Core Generator Logic ---
        function generateLink() {
            // Validation
            if (state.pickupMode === 'custom' && !state.pickup.lat) {
                showToast("Please select a Pickup location");
                return;
            }
            if (!state.dropoff.lat) {
                showToast("Please select a Destination");
                return;
            }

            // Construct Deep Link
            // Uber Deep Link Format: https://m.uber.com/ul/?action=setPickup&client_id=...&pickup=...&dropoff=...
            let url = "https://m.uber.com/ul/?action=setPickup";

            // Add Pickup
            if (state.pickupMode === 'current') {
                url += "&pickup=my_location";
            } else {
                url += `&pickup[latitude]=${state.pickup.lat}&pickup[longitude]=${state.pickup.lng}&pickup[nickname]=${encodeURIComponent(state.pickup.address)}`;
            }

            // Add Dropoff
            url += `&dropoff[latitude]=${state.dropoff.lat}&dropoff[longitude]=${state.dropoff.lng}&dropoff[nickname]=${encodeURIComponent(state.dropoff.address)}`;

            state.generatedUrl = url;

            // Update UI
            document.getElementById('result-section').classList.remove('hidden');
            document.getElementById('btn-open-uber').href = url;
            
            // Scroll to result
            document.getElementById('result-section').scrollIntoView({ behavior: 'smooth' });

            // Generate Card Content
            document.getElementById('card-pickup-text').innerText = state.pickupMode === 'current' ? "Current Location" : state.pickup.address.substring(0, 30) + (state.pickup.address.length > 30 ? "..." : "");
            document.getElementById('card-dropoff-text').innerText = state.dropoff.address.substring(0, 30) + (state.dropoff.address.length > 30 ? "..." : "");

            // Generate QR Code
            const qrContainer = document.getElementById("qrcode");
            qrContainer.innerHTML = ""; // clear previous
            
            // Calculate width based on container but limit it
            new QRCode(qrContainer, {
                text: url,
                width: 200,
                height: 200,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
        }

        // --- Action Buttons ---
        function copyLink() {
            if(!state.generatedUrl) return;
            
            // Create temporary element to copy from (better mobile compatibility than navigator.clipboard sometimes)
            const el = document.createElement('textarea');
            el.value = state.generatedUrl;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            
            showToast("Link copied to clipboard!");
        }

        async function shareLink() {
            if (navigator.share && state.generatedUrl) {
                try {
                    await navigator.share({
                        title: 'Uber Ride Link',
                        text: `Here is the ride link from ${state.pickup.address} to ${state.dropoff.address}`,
                        url: state.generatedUrl
                    });
                } catch (err) {
                    console.log('Share canceled');
                }
            } else {
                copyLink(); // Fallback
            }
        }

        function downloadCard() {
            const card = document.getElementById('share-card');
            showToast("Generating image...");
            
            html2canvas(card, {
                scale: 3, // High resolution
                backgroundColor: null,
                useCORS: true // vital for some resources
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `uber-ride-${Date.now()}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
                showToast("Image downloaded!");
            }).catch(err => {
                showToast("Error generating image.");
                console.error(err);
            });
        }

        // --- Utility ---
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.innerText = message;
            toast.style.opacity = '1';
            setTimeout(() => {
                toast.style.opacity = '0';
            }, 3000);
        }

    </script>
</body>
</html>
